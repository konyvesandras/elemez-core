<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8">
  <title>elemez-core – app</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,Roboto,Arial;margin:1rem;max-width:900px}
    .meta{background:#f6f8fa;padding:.6rem;border-left:4px solid #607d8b;margin-bottom:1rem}
    .content{white-space:pre-wrap;padding:.6rem;background:#fff;border:1px solid #eee}
    .highlight{background:#ffeb3b;padding:0 2px}
    .controls{margin-top:.6rem}
    button{padding:.4rem .6rem;margin-right:.4rem}
  </style>
</head>
<body>
  <h1>elemez-core – app nézet</h1>
  <div id="meta" class="meta">Betöltés...</div>
  <div id="content" class="content" contenteditable="false">Betöltés...</div>

  <div class="controls">
    <button id="btnLoadKiemel">Kiemeltek betöltése</button>
    <button id="btnClear">Töröl kijelölést</button>
    <span id="selectionInfo"></span>
  </div>

  <script>
    const adapterUrl = '../api/adapter.php'; // adapter végpont
    const kiemelApi = '../api/kiemel.php';
    let currentItems = [];

    async function fetchData() {
      const res = await fetch(adapterUrl + '?source=amp');
      return res.json();
    }

    function renderItems(items) {
      // items: tömb, általában [metaObj, {szoveg: "..."}, {zaras: "..."}]
      currentItems = items;
      const metaEl = document.getElementById('meta');
      const contentEl = document.getElementById('content');
      metaEl.innerHTML = '';
      contentEl.innerHTML = '';
      // keressünk cim mezőt: első item, ha van cim
      let metaHtml = '';
      items.forEach(it=>{
        if (it.cim) {
          metaHtml += `<strong>${escapeHtml(it.cim)}</strong><br>`;
          if (it.datum) metaHtml += `<em>${escapeHtml(it.datum)}</em><br>`;
          if (it.szerzo) metaHtml += `${escapeHtml(it.szerzo)}<br>`;
          if (it.letoltes) metaHtml += `<a href="${escapeAttr(it.letoltes)}">Letöltés</a> `;
          if (it.meret) metaHtml += `<small>(${escapeHtml(it.meret)})</small>`;
        }
        if (it.szoveg) {
          // feltételezzük, hogy itt már HTML szerepel (amp-szoveg.php három-nyílás)
          contentEl.innerHTML += it.szoveg;
        }
        if (it.zaras) {
          metaHtml += `<div style="margin-top:.5rem;color:#666">${escapeHtml(it.zaras)}</div>`;
        }
      });
      metaEl.innerHTML = metaHtml || 'Nincs meta adat.';
    }

    // segédfüggvények
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});}
    function escapeAttr(s){ return String(s).replace(/"/g,'&quot;');}

    // Selection handling
    document.getElementById('content').addEventListener('mouseup', () => {
      const sel = window.getSelection();
      const txt = sel.toString().trim();
      const selInfo = document.getElementById('selectionInfo');
      if (txt.length > 0) {
        selInfo.textContent = `Kijelölt szó: "${txt}"`;
        // show quick save prompt (for simplicity, auto-save on click)
        if (confirm(`Mentse a "${txt}" szót kiemeltként?`)) {
          saveKiemelt(txt, sel.anchorNode ? sel.anchorNode.textContent : '');
          // optionally wrap selection with span.highlight (simple approach)
          wrapSelectionWithHighlight();
        }
      } else selInfo.textContent = '';
    });

    document.getElementById('btnClear').addEventListener('click', ()=> {
      window.getSelection().removeAllRanges();
      document.getElementById('selectionInfo').textContent = '';
    });

    async function saveKiemelt(word, context='') {
      try {
        const res = await fetch(kiemelApi, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({word, context, meta:{source:'app'}})
        });
        const j = await res.json();
        alert('Kiemelés: ' + (j.status || JSON.stringify(j)));
      } catch (e) {
        alert('Hiba a mentésnél: ' + e);
      }
    }

    function wrapSelectionWithHighlight() {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      if (range.collapsed) return;
      const span = document.createElement('span');
      span.className = 'highlight';
      try {
        range.surroundContents(span);
      } catch (e) {
        // surroundContents failhat ha részben illeszkedő csomópontokat választunk,
        // egyszerű fallback: extractContents és beillesztés
        const docFrag = range.extractContents();
        span.appendChild(docFrag);
        range.insertNode(span);
      }
      sel.removeAllRanges();
    }

    document.getElementById('btnLoadKiemel').addEventListener('click', async ()=>{
      const r = await fetch(kiemelApi);
      const arr = await r.json();
      alert('Kiemeltek: ' + arr.map(x=>x.word).join(', '));
    });

    // init
    (async ()=> {
      try {
        const data = await fetchData();
        if (data && data.items) renderItems(data.items);
      } catch (e) {
        document.getElementById('meta').textContent = 'Hiba a betöltéskor: ' + e;
        document.getElementById('content').textContent = '';
      }
    })();
  </script>
</body>
</html>
